{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///opt/apps/frontend/lib/auth/tokens.ts"],"sourcesContent":["import jwt from \"jsonwebtoken\";\n\nconst DEFAULT_EXPIRATION = \"1h\";\nconst MFA_TOKEN_EXPIRATION = \"10m\";\nconst AUTH_SECRET = process.env.AUTH_SECRET || \"dev-insecure-secret-change\";\n\nexport type AuthTokenPayload = {\n  sub: number;\n  email: string;\n  name: string;\n  role: string;\n};\n\ntype MfaTokenPurpose = \"setup\" | \"verify\";\n\nexport type MfaTokenPayload = {\n  sub: number;\n  email: string;\n  purpose: MfaTokenPurpose;\n};\n\nexport function createAuthToken(payload: AuthTokenPayload) {\n  return jwt.sign(payload, AUTH_SECRET, {\n    expiresIn: DEFAULT_EXPIRATION,\n  });\n}\n\nexport function verifyAuthToken(token: string) {\n  return jwt.verify(token, AUTH_SECRET) as AuthTokenPayload & {\n    iat: number;\n    exp: number;\n  };\n}\n\nexport function createMfaToken(payload: MfaTokenPayload) {\n  return jwt.sign(payload, AUTH_SECRET, {\n    expiresIn: MFA_TOKEN_EXPIRATION,\n  });\n}\n\nexport function verifyMfaToken(token: string, expectedPurpose: MfaTokenPurpose) {\n  const payload = jwt.verify(token, AUTH_SECRET) as MfaTokenPayload & {\n    iat: number;\n    exp: number;\n  };\n  if (payload.purpose !== expectedPurpose) {\n    throw new Error(\"Invalid MFA token purpose\");\n  }\n  return payload;\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;AAEA,MAAM,qBAAqB;AAC3B,MAAM,uBAAuB;AAC7B,MAAM,cAAc,QAAQ,GAAG,CAAC,WAAW,IAAI;AAiBxC,SAAS,gBAAgB,OAAyB;IACvD,OAAO,kJAAG,CAAC,IAAI,CAAC,SAAS,aAAa;QACpC,WAAW;IACb;AACF;AAEO,SAAS,gBAAgB,KAAa;IAC3C,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;AAI3B;AAEO,SAAS,eAAe,OAAwB;IACrD,OAAO,kJAAG,CAAC,IAAI,CAAC,SAAS,aAAa;QACpC,WAAW;IACb;AACF;AAEO,SAAS,eAAe,KAAa,EAAE,eAAgC;IAC5E,MAAM,UAAU,kJAAG,CAAC,MAAM,CAAC,OAAO;IAIlC,IAAI,QAAQ,OAAO,KAAK,iBAAiB;QACvC,MAAM,IAAI,MAAM;IAClB;IACA,OAAO;AACT"}},
    {"offset": {"line": 127, "column": 0}, "map": {"version":3,"sources":["file:///opt/apps/frontend/lib/auth/database.ts"],"sourcesContent":["import fs from \"fs\";\nimport path from \"path\";\nimport Database from \"better-sqlite3\";\n\nconst dataDir = path.join(process.cwd(), \"data\");\nconst dbFile = path.join(dataDir, \"auth.db\");\n\nif (!fs.existsSync(dataDir)) {\n  fs.mkdirSync(dataDir, { recursive: true });\n}\n\nconst db = new Database(dbFile);\n\ndb.pragma(\"journal_mode = WAL\");\n\ndb.exec(`\n  CREATE TABLE IF NOT EXISTS users (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    email TEXT UNIQUE NOT NULL,\n    password_hash TEXT NOT NULL,\n    name TEXT NOT NULL,\n    avatar TEXT,\n    role TEXT DEFAULT 'analista',\n    is_active INTEGER DEFAULT 1,\n    mfa_secret TEXT,\n    mfa_enabled INTEGER DEFAULT 0,\n    last_seen_at TEXT,\n    created_at TEXT DEFAULT CURRENT_TIMESTAMP\n  );\n`);\n\ntype TableInfoRow = {\n  name: string;\n};\n\nconst tableInfo = db\n  .prepare(\"PRAGMA table_info(users)\")\n  .all() as TableInfoRow[];\n\nconst hasRoleColumn = tableInfo.some((column) => column.name === \"role\");\nconst hasIsActiveColumn = tableInfo.some(\n  (column) => column.name === \"is_active\"\n);\nconst hasMfaSecretColumn = tableInfo.some(\n  (column) => column.name === \"mfa_secret\"\n);\nconst hasMfaEnabledColumn = tableInfo.some(\n  (column) => column.name === \"mfa_enabled\"\n);\nconst hasLastSeenColumn = tableInfo.some(\n  (column) => column.name === \"last_seen_at\"\n);\n\nif (!hasRoleColumn) {\n  db.exec(\"ALTER TABLE users ADD COLUMN role TEXT DEFAULT 'analista'\");\n}\n\nif (!hasIsActiveColumn) {\n  db.exec(\"ALTER TABLE users ADD COLUMN is_active INTEGER DEFAULT 1\");\n  db.exec(\"UPDATE users SET is_active = 1 WHERE is_active IS NULL\");\n}\n\nif (!hasMfaSecretColumn) {\n  db.exec(\"ALTER TABLE users ADD COLUMN mfa_secret TEXT\");\n}\n\nif (!hasMfaEnabledColumn) {\n  db.exec(\"ALTER TABLE users ADD COLUMN mfa_enabled INTEGER DEFAULT 0\");\n  db.exec(\"UPDATE users SET mfa_enabled = 0 WHERE mfa_enabled IS NULL\");\n}\n\nif (!hasLastSeenColumn) {\n  db.exec(\"ALTER TABLE users ADD COLUMN last_seen_at TEXT\");\n}\n\ndb.exec(`\n  CREATE TABLE IF NOT EXISTS action_requests (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    action_type TEXT NOT NULL,\n    filter_mode TEXT NOT NULL,\n    filter_value TEXT NOT NULL,\n    requested_status TEXT,\n    payload TEXT,\n    requester_id INTEGER,\n    requester_email TEXT,\n    requester_name TEXT,\n    status TEXT DEFAULT 'pending',\n    created_at TEXT DEFAULT CURRENT_TIMESTAMP,\n    approved_at TEXT,\n    approved_by TEXT,\n    audit_notes TEXT\n  );\n`);\n\ndb.exec(`\n  CREATE TABLE IF NOT EXISTS notifications (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    user_id INTEGER NOT NULL,\n    type TEXT NOT NULL,\n    title TEXT NOT NULL,\n    message TEXT NOT NULL,\n    payload TEXT,\n    is_read INTEGER DEFAULT 0,\n    created_at TEXT DEFAULT CURRENT_TIMESTAMP,\n    read_at TEXT\n  );\n`);\n\ndb.exec(`\n  CREATE INDEX IF NOT EXISTS idx_notifications_user_read\n  ON notifications (user_id, is_read, created_at);\n`);\n\ndb.exec(`\n  CREATE TABLE IF NOT EXISTS integration_settings (\n    key TEXT PRIMARY KEY,\n    value TEXT\n  );\n`);\n\ndb.exec(`\n  CREATE TABLE IF NOT EXISTS automation_jobs (\n    id TEXT PRIMARY KEY,\n    name TEXT NOT NULL,\n    description TEXT,\n    owner TEXT NOT NULL,\n    queue_seconds INTEGER DEFAULT 0,\n    pending_issues INTEGER DEFAULT 0,\n    duration_seconds INTEGER DEFAULT 0,\n    last_run TEXT,\n    status_code INTEGER DEFAULT 3,\n    created_at TEXT DEFAULT CURRENT_TIMESTAMP,\n    updated_at TEXT DEFAULT CURRENT_TIMESTAMP\n  );\n`);\n\ndb.exec(`\n  CREATE TABLE IF NOT EXISTS automation_job_logs (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    job_id TEXT NOT NULL,\n    message TEXT NOT NULL,\n    level TEXT DEFAULT 'info',\n    created_at TEXT DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (job_id) REFERENCES automation_jobs(id) ON DELETE CASCADE\n  );\n`);\n\ndb.exec(`\n  CREATE TABLE IF NOT EXISTS idea_suggestions (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    user_id INTEGER NOT NULL,\n    user_email TEXT NOT NULL,\n    user_name TEXT NOT NULL,\n    content TEXT NOT NULL,\n    status TEXT DEFAULT 'pending',\n    implementation_stage TEXT DEFAULT 'Descoberta',\n    created_at TEXT DEFAULT CURRENT_TIMESTAMP\n  );\n`);\n\nconst suggestionTableInfo = db\n  .prepare(\"PRAGMA table_info(idea_suggestions)\")\n  .all() as TableInfoRow[];\n\nconst hasSuggestionStatusColumn = suggestionTableInfo.some(\n  (column) => column.name === \"status\"\n);\nconst hasImplementationStageColumn = suggestionTableInfo.some(\n  (column) => column.name === \"implementation_stage\"\n);\n\nif (!hasSuggestionStatusColumn) {\n  db.exec(\"ALTER TABLE idea_suggestions ADD COLUMN status TEXT DEFAULT 'pending'\");\n  db.exec(\n    \"UPDATE idea_suggestions SET status = 'pending' WHERE status IS NULL OR status = ''\"\n  );\n}\n\nif (!hasImplementationStageColumn) {\n  db.exec(\n    \"ALTER TABLE idea_suggestions ADD COLUMN implementation_stage TEXT DEFAULT 'Descoberta'\"\n  );\n  db.exec(\n    \"UPDATE idea_suggestions SET implementation_stage = 'Descoberta' WHERE implementation_stage IS NULL OR implementation_stage = ''\"\n  );\n}\n\ndb.exec(`\n  CREATE TABLE IF NOT EXISTS playbooks (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    name TEXT NOT NULL,\n    description TEXT,\n    squads TEXT NOT NULL,\n    automations TEXT NOT NULL,\n    status TEXT NOT NULL DEFAULT 'em validação',\n    last_run TEXT,\n    steps TEXT NOT NULL,\n    script_path TEXT,\n    created_at TEXT DEFAULT CURRENT_TIMESTAMP,\n    updated_at TEXT DEFAULT CURRENT_TIMESTAMP\n  );\n`);\n\nconst playbookTableInfo = db\n  .prepare(\"PRAGMA table_info(playbooks)\")\n  .all() as TableInfoRow[];\n\nconst hasScriptPathColumn = playbookTableInfo.some(\n  (column) => column.name === \"script_path\"\n);\n\nif (!hasScriptPathColumn) {\n  db.exec(\"ALTER TABLE playbooks ADD COLUMN script_path TEXT\");\n}\n\ntype PlaybookRow = {\n  total: number;\n};\n\nconst playbookCount = db\n  .prepare<PlaybookRow>(\"SELECT COUNT(*) as total FROM playbooks\")\n  .get();\n\nif ((playbookCount?.total ?? 0) === 0) {\n  const insertPlaybook = db.prepare(\n    `INSERT INTO playbooks\n      (name, description, squads, automations, status, last_run, steps, script_path)\n     VALUES (?, ?, ?, ?, ?, ?, ?, ?)`\n  );\n\n  const seeds = [\n    {\n      name: \"Reforço OWASP Top 10\",\n      description:\n        \"Escaneia superfícies expostas, abre issues Jira e envia comandos para correções automáticas nos microserviços.\",\n      squads: [\"Portal B2C\", \"Checkout\"],\n      automations: [\"JQL: label=owasp_top10\", \"Webhook: pipelines-devsecops\"],\n      status: \"pronto\",\n      last_run: \"Há 2 dias\",\n      steps: [\n        {\n          title: \"Detectar superficies\",\n          detail: \"Executar scanners Tenable e APIs internas para serviço web.\",\n        },\n        {\n          title: \"Abrir issues\",\n          detail: \"Criar tickets Jira por squad com prioridade automática.\",\n        },\n        {\n          title: \"Aplicar correções\",\n          detail: \"Disparar playbooks React + Vite para ajustar pipelines.\",\n        },\n      ],\n      scriptPath: \"scripts/owasp_reinforcement.sh\",\n    },\n    {\n      name: \"Resiliência de Identidades\",\n      description:\n        \"Revisa todas as identidades privilegiadas, aplica MFA obrigatório e dispara alertas quando políticas são quebradas.\",\n      squads: [\"IAM\", \"Infra Sec\"],\n      automations: [\"Suspender contas inativas\", \"Sincronizar MFA\"],\n      status: \"em validação\",\n      last_run: \"Há 6 horas\",\n      steps: [\n        {\n          title: \"Inventário IAM\",\n          detail: \"Listar contas privilegiadas e verificar status MFA.\",\n        },\n        {\n          title: \"Aplicar políticas\",\n          detail: \"Sincronizar MFA e bloquear exceções automaticamente.\",\n        },\n        {\n          title: \"Alertar squads\",\n          detail: \"Enviar relatórios para SOC e líderes das tribos.\",\n        },\n      ],\n      scriptPath: \"scripts/iam_resilience.py\",\n    },\n    {\n      name: \"Higienização de Repositórios\",\n      description:\n        \"Fluxo para rodar scanners de segredos, abrir tickets e integrar com pipelines React + Vite automaticamente.\",\n      squads: [\"DevRel\", \"DevSecOps\"],\n      automations: [\"Scanner secrets\", \"Remover tokens vazados\"],\n      status: \"em construção\",\n      last_run: \"Em preparação\",\n      steps: [\n        {\n          title: \"Rodar scanners\",\n          detail: \"Executar detecção de segredos em repositórios React.\",\n        },\n        {\n          title: \"Iniciar remediação\",\n          detail: \"Abrir tickets e atribuir tasks automáticas por squad.\",\n        },\n        {\n          title: \"Validar build\",\n          detail: \"Ajustar pipelines Vite para prevenir regressões.\",\n        },\n      ],\n      scriptPath: \"scripts/higienizacao_repos.sh\",\n    },\n    {\n      name: \"Limpeza e Scans Tenable\",\n      description:\n        \"Remove scans antigos do Tenable.VM para impedir que o limite de 10k seja atingido e garante continuidade dos assessments.\",\n      squads: [\"Vulnerability Ops\", \"Infra Sec\"],\n      automations: [\n        \"Cleanup scans Tenable.VM\",\n        \"Monitor limite 10k\",\n        \"Notificar SOC\",\n      ],\n      status: \"pronto\",\n      last_run: \"Há 1 hora\",\n      steps: [\n        {\n          title: \"Identificar scans antigos\",\n          detail: \"Listar execuções acima de 30 dias e sinalizar excedentes.\",\n        },\n        {\n          title: \"Remover do Tenable.VM\",\n          detail: \"Executar API de exclusão mantendo histórico local.\",\n        },\n        {\n          title: \"Notificar SOC\",\n          detail: \"Enviar relatório e garantir capacidade abaixo de 10k.\",\n        },\n      ],\n      scriptPath: \"scripts/tenable_cleanup.sh\",\n    },\n    {\n      name: \"Atualização de senha Tenable.IE\",\n      description:\n        \"Atualiza a senha em rotação no Tenable.IE para manter a comunicação com o Active Directory Redecorp, evitando falhas nos scanners.\",\n      squads: [\"IAM\", \"Vulnerability Ops\"],\n      automations: [\n        \"Rotacionar credencial serviço\",\n        \"Sincronizar Tenable.IE\",\n        \"Validar comunicação AD Redecorp\",\n      ],\n      status: \"em validação\",\n      last_run: \"Há 30 minutos\",\n      steps: [\n        {\n          title: \"Obter senha nova\",\n          detail: \"Consultar cofre e validar rotação prevista.\",\n        },\n        {\n          title: \"Atualizar Tenable.IE\",\n          detail: \"Aplicar a senha no conector e registrar data.\",\n        },\n        {\n          title: \"Testar AD\",\n          detail: \"Executar teste de comunicação com o Active Directory Redecorp.\",\n        },\n      ],\n      scriptPath: \"scripts/update_tenable_password.py\",\n    },\n  ];\n\n  seeds.forEach((seed) => {\n    insertPlaybook.run(\n      seed.name,\n      seed.description,\n      JSON.stringify(seed.squads),\n      JSON.stringify(seed.automations),\n      seed.status,\n      seed.last_run,\n      JSON.stringify(seed.steps),\n      seed.scriptPath\n    );\n  });\n}\n\ntype CountRow = {\n  total: number;\n};\n\nconst automationJobCount = db\n  .prepare<CountRow>(\"SELECT COUNT(*) as total FROM automation_jobs\")\n  .get();\n\nif ((automationJobCount?.total ?? 0) === 0) {\n  const now = Date.now();\n  const offsetMinutes = (minutes: number) => new Date(now - minutes * 60_000).toISOString();\n  const insertJob = db.prepare(\n    `INSERT INTO automation_jobs\n      (id, name, description, owner, queue_seconds, pending_issues, duration_seconds, last_run, status_code, created_at, updated_at)\n     VALUES (@id, @name, @description, @owner, @queue_seconds, @pending_issues, @duration_seconds, @last_run, @status_code, @created_at, @updated_at)`\n  );\n\n  const seedJobs = [\n    {\n      id: \"sync-web\",\n      name: \"Sync backlog Web\",\n      description: \"Garante sincronismo entre backlogs e issues prioritárias.\",\n      owner: \"Squad Web\",\n      queue_seconds: 42,\n      pending_issues: 37,\n      duration_seconds: 133,\n      last_run: offsetMinutes(4),\n      status_code: 2,\n    },\n    {\n      id: \"close-done\",\n      name: \"Decay 90d\",\n      description: \"Enfileira fechamento automático após 90 dias.\",\n      owner: \"Squad Jira\",\n      queue_seconds: 310,\n      pending_issues: 120,\n      duration_seconds: 105,\n      last_run: offsetMinutes(60),\n      status_code: 3,\n    },\n    {\n      id: \"sla-alert\",\n      name: \"Alertar SLAs críticos\",\n      description: \"Verifica SLAs de squads e dispara alertas.\",\n      owner: \"Automação SOC\",\n      queue_seconds: 0,\n      pending_issues: 18,\n      duration_seconds: 32,\n      last_run: offsetMinutes(12),\n      status_code: 0,\n    },\n    {\n      id: \"bulk-comment\",\n      name: \"Comentário padrão squads\",\n      description: \"Publica comentários de alinhamento automaticamente.\",\n      owner: \"Squad Backlog\",\n      queue_seconds: 0,\n      pending_issues: 0,\n      duration_seconds: 201,\n      last_run: offsetMinutes(20),\n      status_code: 1,\n    },\n  ];\n\n  seedJobs.forEach((job) => {\n    insertJob.run({\n      ...job,\n      created_at: offsetMinutes(120),\n      updated_at: offsetMinutes(2),\n    });\n  });\n\n  const insertLog = db.prepare(\n    `INSERT INTO automation_job_logs (job_id, message, level, created_at)\n     VALUES (?, ?, ?, ?)`\n  );\n\n  insertLog.run(\n    \"sync-web\",\n    \"37 issues sincronizadas. Jira: OK · DB: OK\",\n    \"info\",\n    offsetMinutes(4)\n  );\n  insertLog.run(\n    \"sla-alert\",\n    \"Erro HTTP 429 ao consultar API Jira. Será reexecutado em 5 minutos.\",\n    \"error\",\n    offsetMinutes(12)\n  );\n  insertLog.run(\n    \"close-done\",\n    \"Fila aguardando slot livre. Esperando aprovação manual.\",\n    \"warning\",\n    offsetMinutes(60)\n  );\n  insertLog.run(\n    \"bulk-comment\",\n    \"Comentário aplicado em 64 issues. Sem falhas.\",\n    \"info\",\n    offsetMinutes(20)\n  );\n}\n\nexport { db };\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,MAAM,UAAU,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI;AACzC,MAAM,SAAS,4GAAI,CAAC,IAAI,CAAC,SAAS;AAElC,IAAI,CAAC,wGAAE,CAAC,UAAU,CAAC,UAAU;IAC3B,wGAAE,CAAC,SAAS,CAAC,SAAS;QAAE,WAAW;IAAK;AAC1C;AAEA,MAAM,KAAK,IAAI,sIAAQ,CAAC;AAExB,GAAG,MAAM,CAAC;AAEV,GAAG,IAAI,CAAC,CAAC;;;;;;;;;;;;;;AAcT,CAAC;AAMD,MAAM,YAAY,GACf,OAAO,CAAC,4BACR,GAAG;AAEN,MAAM,gBAAgB,UAAU,IAAI,CAAC,CAAC,SAAW,OAAO,IAAI,KAAK;AACjE,MAAM,oBAAoB,UAAU,IAAI,CACtC,CAAC,SAAW,OAAO,IAAI,KAAK;AAE9B,MAAM,qBAAqB,UAAU,IAAI,CACvC,CAAC,SAAW,OAAO,IAAI,KAAK;AAE9B,MAAM,sBAAsB,UAAU,IAAI,CACxC,CAAC,SAAW,OAAO,IAAI,KAAK;AAE9B,MAAM,oBAAoB,UAAU,IAAI,CACtC,CAAC,SAAW,OAAO,IAAI,KAAK;AAG9B,IAAI,CAAC,eAAe;IAClB,GAAG,IAAI,CAAC;AACV;AAEA,IAAI,CAAC,mBAAmB;IACtB,GAAG,IAAI,CAAC;IACR,GAAG,IAAI,CAAC;AACV;AAEA,IAAI,CAAC,oBAAoB;IACvB,GAAG,IAAI,CAAC;AACV;AAEA,IAAI,CAAC,qBAAqB;IACxB,GAAG,IAAI,CAAC;IACR,GAAG,IAAI,CAAC;AACV;AAEA,IAAI,CAAC,mBAAmB;IACtB,GAAG,IAAI,CAAC;AACV;AAEA,GAAG,IAAI,CAAC,CAAC;;;;;;;;;;;;;;;;;AAiBT,CAAC;AAED,GAAG,IAAI,CAAC,CAAC;;;;;;;;;;;;AAYT,CAAC;AAED,GAAG,IAAI,CAAC,CAAC;;;AAGT,CAAC;AAED,GAAG,IAAI,CAAC,CAAC;;;;;AAKT,CAAC;AAED,GAAG,IAAI,CAAC,CAAC;;;;;;;;;;;;;;AAcT,CAAC;AAED,GAAG,IAAI,CAAC,CAAC;;;;;;;;;AAST,CAAC;AAED,GAAG,IAAI,CAAC,CAAC;;;;;;;;;;;AAWT,CAAC;AAED,MAAM,sBAAsB,GACzB,OAAO,CAAC,uCACR,GAAG;AAEN,MAAM,4BAA4B,oBAAoB,IAAI,CACxD,CAAC,SAAW,OAAO,IAAI,KAAK;AAE9B,MAAM,+BAA+B,oBAAoB,IAAI,CAC3D,CAAC,SAAW,OAAO,IAAI,KAAK;AAG9B,IAAI,CAAC,2BAA2B;IAC9B,GAAG,IAAI,CAAC;IACR,GAAG,IAAI,CACL;AAEJ;AAEA,IAAI,CAAC,8BAA8B;IACjC,GAAG,IAAI,CACL;IAEF,GAAG,IAAI,CACL;AAEJ;AAEA,GAAG,IAAI,CAAC,CAAC;;;;;;;;;;;;;;AAcT,CAAC;AAED,MAAM,oBAAoB,GACvB,OAAO,CAAC,gCACR,GAAG;AAEN,MAAM,sBAAsB,kBAAkB,IAAI,CAChD,CAAC,SAAW,OAAO,IAAI,KAAK;AAG9B,IAAI,CAAC,qBAAqB;IACxB,GAAG,IAAI,CAAC;AACV;AAMA,MAAM,gBAAgB,GACnB,OAAO,CAAc,2CACrB,GAAG;AAEN,IAAI,CAAC,eAAe,SAAS,CAAC,MAAM,GAAG;IACrC,MAAM,iBAAiB,GAAG,OAAO,CAC/B,CAAC;;oCAE+B,CAAC;IAGnC,MAAM,QAAQ;QACZ;YACE,MAAM;YACN,aACE;YACF,QAAQ;gBAAC;gBAAc;aAAW;YAClC,aAAa;gBAAC;gBAA0B;aAA+B;YACvE,QAAQ;YACR,UAAU;YACV,OAAO;gBACL;oBACE,OAAO;oBACP,QAAQ;gBACV;gBACA;oBACE,OAAO;oBACP,QAAQ;gBACV;gBACA;oBACE,OAAO;oBACP,QAAQ;gBACV;aACD;YACD,YAAY;QACd;QACA;YACE,MAAM;YACN,aACE;YACF,QAAQ;gBAAC;gBAAO;aAAY;YAC5B,aAAa;gBAAC;gBAA6B;aAAkB;YAC7D,QAAQ;YACR,UAAU;YACV,OAAO;gBACL;oBACE,OAAO;oBACP,QAAQ;gBACV;gBACA;oBACE,OAAO;oBACP,QAAQ;gBACV;gBACA;oBACE,OAAO;oBACP,QAAQ;gBACV;aACD;YACD,YAAY;QACd;QACA;YACE,MAAM;YACN,aACE;YACF,QAAQ;gBAAC;gBAAU;aAAY;YAC/B,aAAa;gBAAC;gBAAmB;aAAyB;YAC1D,QAAQ;YACR,UAAU;YACV,OAAO;gBACL;oBACE,OAAO;oBACP,QAAQ;gBACV;gBACA;oBACE,OAAO;oBACP,QAAQ;gBACV;gBACA;oBACE,OAAO;oBACP,QAAQ;gBACV;aACD;YACD,YAAY;QACd;QACA;YACE,MAAM;YACN,aACE;YACF,QAAQ;gBAAC;gBAAqB;aAAY;YAC1C,aAAa;gBACX;gBACA;gBACA;aACD;YACD,QAAQ;YACR,UAAU;YACV,OAAO;gBACL;oBACE,OAAO;oBACP,QAAQ;gBACV;gBACA;oBACE,OAAO;oBACP,QAAQ;gBACV;gBACA;oBACE,OAAO;oBACP,QAAQ;gBACV;aACD;YACD,YAAY;QACd;QACA;YACE,MAAM;YACN,aACE;YACF,QAAQ;gBAAC;gBAAO;aAAoB;YACpC,aAAa;gBACX;gBACA;gBACA;aACD;YACD,QAAQ;YACR,UAAU;YACV,OAAO;gBACL;oBACE,OAAO;oBACP,QAAQ;gBACV;gBACA;oBACE,OAAO;oBACP,QAAQ;gBACV;gBACA;oBACE,OAAO;oBACP,QAAQ;gBACV;aACD;YACD,YAAY;QACd;KACD;IAED,MAAM,OAAO,CAAC,CAAC;QACb,eAAe,GAAG,CAChB,KAAK,IAAI,EACT,KAAK,WAAW,EAChB,KAAK,SAAS,CAAC,KAAK,MAAM,GAC1B,KAAK,SAAS,CAAC,KAAK,WAAW,GAC/B,KAAK,MAAM,EACX,KAAK,QAAQ,EACb,KAAK,SAAS,CAAC,KAAK,KAAK,GACzB,KAAK,UAAU;IAEnB;AACF;AAMA,MAAM,qBAAqB,GACxB,OAAO,CAAW,iDAClB,GAAG;AAEN,IAAI,CAAC,oBAAoB,SAAS,CAAC,MAAM,GAAG;IAC1C,MAAM,MAAM,KAAK,GAAG;IACpB,MAAM,gBAAgB,CAAC,UAAoB,IAAI,KAAK,MAAM,UAAU,QAAQ,WAAW;IACvF,MAAM,YAAY,GAAG,OAAO,CAC1B,CAAC;;qJAEgJ,CAAC;IAGpJ,MAAM,WAAW;QACf;YACE,IAAI;YACJ,MAAM;YACN,aAAa;YACb,OAAO;YACP,eAAe;YACf,gBAAgB;YAChB,kBAAkB;YAClB,UAAU,cAAc;YACxB,aAAa;QACf;QACA;YACE,IAAI;YACJ,MAAM;YACN,aAAa;YACb,OAAO;YACP,eAAe;YACf,gBAAgB;YAChB,kBAAkB;YAClB,UAAU,cAAc;YACxB,aAAa;QACf;QACA;YACE,IAAI;YACJ,MAAM;YACN,aAAa;YACb,OAAO;YACP,eAAe;YACf,gBAAgB;YAChB,kBAAkB;YAClB,UAAU,cAAc;YACxB,aAAa;QACf;QACA;YACE,IAAI;YACJ,MAAM;YACN,aAAa;YACb,OAAO;YACP,eAAe;YACf,gBAAgB;YAChB,kBAAkB;YAClB,UAAU,cAAc;YACxB,aAAa;QACf;KACD;IAED,SAAS,OAAO,CAAC,CAAC;QAChB,UAAU,GAAG,CAAC;YACZ,GAAG,GAAG;YACN,YAAY,cAAc;YAC1B,YAAY,cAAc;QAC5B;IACF;IAEA,MAAM,YAAY,GAAG,OAAO,CAC1B,CAAC;wBACmB,CAAC;IAGvB,UAAU,GAAG,CACX,YACA,8CACA,QACA,cAAc;IAEhB,UAAU,GAAG,CACX,aACA,uEACA,SACA,cAAc;IAEhB,UAAU,GAAG,CACX,cACA,2DACA,WACA,cAAc;IAEhB,UAAU,GAAG,CACX,gBACA,iDACA,QACA,cAAc;AAElB"}},
    {"offset": {"line": 523, "column": 0}, "map": {"version":3,"sources":["file:///opt/apps/frontend/lib/auth/password.ts"],"sourcesContent":["import crypto from \"crypto\";\n\nexport function hashPassword(password: string) {\n  const salt = crypto.randomBytes(16).toString(\"hex\");\n  const hash = crypto.scryptSync(password, salt, 64).toString(\"hex\");\n  return `${salt}:${hash}`;\n}\n\nexport function verifyPassword(password: string, storedHash: string) {\n  const [salt, hash] = storedHash.split(\":\");\n  if (!salt || !hash) {\n    return false;\n  }\n\n  const derived = crypto.scryptSync(password, salt, 64);\n  const stored = Buffer.from(hash, \"hex\");\n  return crypto.timingSafeEqual(derived, stored);\n}\n"],"names":[],"mappings":";;;;;;AAAA;;AAEO,SAAS,aAAa,QAAgB;IAC3C,MAAM,OAAO,gHAAM,CAAC,WAAW,CAAC,IAAI,QAAQ,CAAC;IAC7C,MAAM,OAAO,gHAAM,CAAC,UAAU,CAAC,UAAU,MAAM,IAAI,QAAQ,CAAC;IAC5D,OAAO,GAAG,KAAK,CAAC,EAAE,MAAM;AAC1B;AAEO,SAAS,eAAe,QAAgB,EAAE,UAAkB;IACjE,MAAM,CAAC,MAAM,KAAK,GAAG,WAAW,KAAK,CAAC;IACtC,IAAI,CAAC,QAAQ,CAAC,MAAM;QAClB,OAAO;IACT;IAEA,MAAM,UAAU,gHAAM,CAAC,UAAU,CAAC,UAAU,MAAM;IAClD,MAAM,SAAS,OAAO,IAAI,CAAC,MAAM;IACjC,OAAO,gHAAM,CAAC,eAAe,CAAC,SAAS;AACzC"}},
    {"offset": {"line": 549, "column": 0}, "map": {"version":3,"sources":["file:///opt/apps/frontend/lib/auth/user-service.ts"],"sourcesContent":["import { db } from \"@/lib/auth/database\";\nimport { hashPassword, verifyPassword } from \"@/lib/auth/password\";\n\nexport type UserRecord = {\n  id: number;\n  email: string;\n  name: string;\n  avatar: string | null;\n  password_hash: string;\n  role: string;\n  is_active: number;\n  mfa_secret: string | null;\n  mfa_enabled: number;\n  last_seen_at: string | null;\n  created_at: string;\n};\n\nconst seedUser = {\n  email: \"admin@postura.com\",\n  password: \"cyber123\",\n  name: \"Administrador Postura SM\",\n  avatar: \"/logo_vivo_sem_fundo.png\",\n  role: \"admin\",\n};\n\nlet isSeeded = false;\n\nfunction seedAdmin() {\n  if (isSeeded) return;\n  const stmt = db.prepare(\n    \"SELECT id, role, is_active FROM users WHERE email = ?\"\n  );\n  const existing = stmt.get(seedUser.email) as\n    | { id: number; role?: string | null; is_active?: number | null }\n    | undefined;\n\n  if (!existing) {\n    const insert = db.prepare(\n      \"INSERT INTO users (email, password_hash, name, avatar, role, is_active) VALUES (?, ?, ?, ?, ?, 1)\"\n    );\n    insert.run(\n      seedUser.email,\n      hashPassword(seedUser.password),\n      seedUser.name,\n      seedUser.avatar,\n      seedUser.role\n    );\n  } else if (existing.role !== seedUser.role || existing.is_active !== 1) {\n    const update = db.prepare(\n      \"UPDATE users SET role = ?, is_active = 1 WHERE id = ?\"\n    );\n    update.run(seedUser.role, existing.id);\n  }\n\n  isSeeded = true;\n}\n\nexport function findUserByEmail(email: string): UserRecord | undefined {\n  seedAdmin();\n  const stmt = db.prepare(\n    \"SELECT id, email, name, avatar, password_hash, role, is_active, mfa_secret, mfa_enabled, last_seen_at, created_at FROM users WHERE email = ?\"\n  );\n  return stmt.get(email);\n}\n\nexport function validateUserCredentials(\n  email: string,\n  password: string\n): UserRecord | null {\n  const user = findUserByEmail(email);\n  if (!user) return null;\n\n  const isValid = verifyPassword(password, user.password_hash);\n  if (!isValid) {\n    return null;\n  }\n\n  if (!user.is_active) {\n    return null;\n  }\n\n  return user;\n}\n\ntype CreateUserInput = {\n  name: string;\n  email: string;\n  password: string;\n  role: string;\n  avatar?: string | null;\n};\n\nexport function createUser({\n  name,\n  email,\n  password,\n  role,\n  avatar = null,\n}: CreateUserInput): UserRecord {\n  seedAdmin();\n  const normalizedEmail = email.trim().toLowerCase();\n\n  const insert = db.prepare(\n    \"INSERT INTO users (name, email, password_hash, role, avatar, is_active) VALUES (?, ?, ?, ?, ?, 1)\"\n  );\n\n  const result = insert.run(\n    name.trim(),\n    normalizedEmail,\n    hashPassword(password),\n    role,\n    avatar\n  );\n\n  const insertedId = Number(result.lastInsertRowid);\n\n  const fetchNew = db.prepare<UserRecord>(\n    \"SELECT id, email, name, avatar, password_hash, role, is_active, mfa_secret, mfa_enabled, last_seen_at, created_at FROM users WHERE id = ?\"\n  );\n  const created = fetchNew.get(insertedId);\n\n  if (!created) {\n    throw new Error(\"Falha ao criar usuário.\");\n  }\n\n  return created;\n}\n\ntype BasicAdmin = {\n  id: number;\n  name: string;\n  email: string;\n};\n\nexport function listAdmins(): BasicAdmin[] {\n  seedAdmin();\n  const stmt = db.prepare<BasicAdmin>(\n    \"SELECT id, name, email FROM users WHERE role = 'admin'\"\n  );\n  return stmt.all();\n}\n\nexport type UserSummary = {\n  id: number;\n  name: string;\n  email: string;\n  role: string;\n  created_at: string;\n  is_active: number;\n  last_seen_at: string | null;\n};\n\nexport function listUsers(): UserSummary[] {\n  seedAdmin();\n  const stmt = db.prepare<UserSummary>(\n    \"SELECT id, name, email, role, created_at, is_active, last_seen_at FROM users ORDER BY created_at DESC\"\n  );\n  return stmt.all();\n}\n\nexport function updateUserActiveStatus(\n  userId: number,\n  isActive: boolean\n): UserRecord | null {\n  seedAdmin();\n  const update = db.prepare(\n    \"UPDATE users SET is_active = ? WHERE id = ?\"\n  );\n  const result = update.run(isActive ? 1 : 0, userId);\n\n  if (result.changes === 0) {\n    return null;\n  }\n\n  const fetch = db.prepare<UserRecord>(\n    \"SELECT id, email, name, avatar, password_hash, role, is_active, mfa_secret, mfa_enabled, last_seen_at, created_at FROM users WHERE id = ?\"\n  );\n  return fetch.get(userId) ?? null;\n}\n\nexport function findUserById(id: number): UserRecord | undefined {\n  seedAdmin();\n  const stmt = db.prepare<UserRecord>(\n    \"SELECT id, email, name, avatar, password_hash, role, is_active, mfa_secret, mfa_enabled, last_seen_at, created_at FROM users WHERE id = ?\"\n  );\n  return stmt.get(id);\n}\n\nexport function upsertUserMfaSecret(userId: number, secret: string) {\n  const stmt = db.prepare(\n    \"UPDATE users SET mfa_secret = ?, mfa_enabled = 0 WHERE id = ?\"\n  );\n  stmt.run(secret, userId);\n}\n\nexport function enableUserMfa(userId: number) {\n  const stmt = db.prepare(\n    \"UPDATE users SET mfa_enabled = 1 WHERE id = ?\"\n  );\n  stmt.run(userId);\n}\n\nexport function updateUserLastSeen(userId: number) {\n  seedAdmin();\n  const stmt = db.prepare(\n    \"UPDATE users SET last_seen_at = CURRENT_TIMESTAMP WHERE id = ?\"\n  );\n  stmt.run(userId);\n}\n\nexport type OnlineAdmin = {\n  id: number;\n  name: string;\n  email: string;\n  last_seen_at: string | null;\n};\n\nexport function listOnlineAdmins(withinMinutes = 5): OnlineAdmin[] {\n  seedAdmin();\n  const stmt = db.prepare<OnlineAdmin>(\n    \"SELECT id, name, email, last_seen_at FROM users WHERE role = 'admin' AND last_seen_at IS NOT NULL AND datetime(last_seen_at) >= datetime('now', ?) ORDER BY datetime(last_seen_at) DESC\"\n  );\n  return stmt.all(`-${withinMinutes} minutes`);\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 675, "column": 0}, "map": {"version":3,"sources":["file:///opt/apps/frontend/app/api/auth/login/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { createMfaToken } from \"@/lib/auth/tokens\";\nimport {\n  findUserByEmail,\n  validateUserCredentials,\n} from \"@/lib/auth/user-service\";\n\ntype LoginRequest = {\n  email?: string;\n  password?: string;\n};\n\nexport async function POST(request: Request) {\n  const body = (await request.json()) as LoginRequest | null;\n\n  const email = body?.email?.trim().toLowerCase();\n  const password = body?.password;\n\n  if (!email || !password) {\n    return NextResponse.json(\n      { error: \"Credenciais inválidas.\" },\n      { status: 400 }\n    );\n  }\n\n  const existingUser = findUserByEmail(email);\n\n  if (!existingUser) {\n    return NextResponse.json(\n      { error: \"E-mail ou senha incorretos.\" },\n      { status: 401 }\n    );\n  }\n\n  if (!existingUser.is_active) {\n    return NextResponse.json(\n      { error: \"Usuário inativo. Solicite a um administrador para reativar.\" },\n      { status: 403 }\n    );\n  }\n\n  const user = validateUserCredentials(email, password);\n\n  if (!user) {\n    return NextResponse.json(\n      { error: \"E-mail ou senha incorretos.\" },\n      { status: 401 }\n    );\n  }\n\n  const baseUser = {\n    id: user.id,\n    email: user.email,\n    name: user.name,\n    avatar: user.avatar,\n    role: user.role,\n    is_active: Boolean(user.is_active),\n  };\n\n  if (!user.mfa_secret || !user.mfa_enabled) {\n    const setupToken = createMfaToken({\n      sub: user.id,\n      email: user.email,\n      purpose: \"setup\",\n    });\n    return NextResponse.json({\n      mfaSetupRequired: true,\n      token: setupToken,\n      user: baseUser,\n    });\n  }\n\n  const mfaToken = createMfaToken({\n    sub: user.id,\n    email: user.email,\n    purpose: \"verify\",\n  });\n\n  return NextResponse.json({\n    mfaRequired: true,\n    token: mfaToken,\n    user: baseUser,\n  });\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAUO,eAAe,KAAK,OAAgB;IACzC,MAAM,OAAQ,MAAM,QAAQ,IAAI;IAEhC,MAAM,QAAQ,MAAM,OAAO,OAAO;IAClC,MAAM,WAAW,MAAM;IAEvB,IAAI,CAAC,SAAS,CAAC,UAAU;QACvB,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAyB,GAClC;YAAE,QAAQ;QAAI;IAElB;IAEA,MAAM,eAAe,IAAA,mJAAe,EAAC;IAErC,IAAI,CAAC,cAAc;QACjB,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA8B,GACvC;YAAE,QAAQ;QAAI;IAElB;IAEA,IAAI,CAAC,aAAa,SAAS,EAAE;QAC3B,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA8D,GACvE;YAAE,QAAQ;QAAI;IAElB;IAEA,MAAM,OAAO,IAAA,2JAAuB,EAAC,OAAO;IAE5C,IAAI,CAAC,MAAM;QACT,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA8B,GACvC;YAAE,QAAQ;QAAI;IAElB;IAEA,MAAM,WAAW;QACf,IAAI,KAAK,EAAE;QACX,OAAO,KAAK,KAAK;QACjB,MAAM,KAAK,IAAI;QACf,QAAQ,KAAK,MAAM;QACnB,MAAM,KAAK,IAAI;QACf,WAAW,QAAQ,KAAK,SAAS;IACnC;IAEA,IAAI,CAAC,KAAK,UAAU,IAAI,CAAC,KAAK,WAAW,EAAE;QACzC,MAAM,aAAa,IAAA,yIAAc,EAAC;YAChC,KAAK,KAAK,EAAE;YACZ,OAAO,KAAK,KAAK;YACjB,SAAS;QACX;QACA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,kBAAkB;YAClB,OAAO;YACP,MAAM;QACR;IACF;IAEA,MAAM,WAAW,IAAA,yIAAc,EAAC;QAC9B,KAAK,KAAK,EAAE;QACZ,OAAO,KAAK,KAAK;QACjB,SAAS;IACX;IAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;QACvB,aAAa;QACb,OAAO;QACP,MAAM;IACR;AACF"}}]
}